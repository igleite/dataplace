USE SPT_WLP_DbSalvatori
GO

/*


Mapeamento do código das colunas geras

11 - Base de cálculo da Contribuição Previdenciária normal;
12 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição;
13 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição;
14 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição;
15 - Base de cálculo da contribuição previdenciária exclusiva do empregador;
21 - Valor total descontado do trabalhador para recolhimento à Previdência Social;
22 - Valor descontado do trabalhador para recolhimento ao Sest;
23 - Valor descontado do trabalhador para recolhimento ao Senat;
31 - Valor pago ao trabalhador a título de salário-família;
32 - Valor pago ao trabalhador a título de salário-maternidade;
41 - Base de cálculo da Contribuição Previdenciária normal – Categorias 107 e 108;
42 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição – Categorias 107 e 108
43 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição – Categorias 107 e 108;
44 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição – Categorias 107 e 108;
45 - Base de cálculo da contribuição previdenciária adicional normal - exclusiva do empregador – Categorias 107 e 108;
46 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;
47 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;
48 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;
49 - Base de cálculo da contribuição previdenciária exclusiva do empregado – Categorias 107 e 108;
81 - Incidência suspensa em decorrência de decisão judicial - Base de cálculo (BC) da Contribuição Previdenciária (CP) Normal – Categorias 107 e 108;
82 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho – Categorias 107 e 108;
83 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho – Categorias 107 e 108;
84 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho – Categorias 107 e 108;
85 - Incidência suspensa em decorrência de decisão judicial - BC CP normal - Exclusiva do empregador – Categorias 107 e 108;
86 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho - Exclusiva do empregador –Categorias 107 e 108;
87 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho - Exclusiva do empregador – Categorias 107 e 108;
88 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho - Exclusiva do empregador – Categorias 107 e 108;
91 - Incidência suspensa em decorrência de decisão judicial - Base de cálculo (BC) da Contribuição Previdenciária (CP) Normal;
92 - Incid. suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho;
93 - Incid. suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho;
94 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho;
16 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição - exclusiva do empregador; 
17 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição - exclusiva do empregador; 
18 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição - exclusiva do empregador; 
19 - Base de cálculo da contribuição previdenciária exclusiva do empregado; 
95 - Incidência suspensa em decorrência de decisão judicial - BC CP normal - Exclusiva do empregador. 
96 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho - Exclusiva do empregador; 
97 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho - Exclusiva do empregador; 
98 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho - Exclusiva do empregador.


*/


DECLARE @cols AS NVARCHAR(MAX);
DECLARE @query AS NVARCHAR(MAX);
DECLARE @perApur AS VARCHAR(MAX);
DECLARE @status AS VARCHAR(MAX);
DECLARE @cpf AS VARCHAR(MAX);


SET @perApur = '2022-09'
SET @status = 'O'
SET @cpf = '32009942825' -- caso não queira buscar o CPF deixar em branco


SET @cols = STUFF((SELECT DISTINCT ', ' + QUOTENAME(tpValor)
                   FROM EFDS_S5001_infoBaseCS
                   FOR XML PATH('')), 1, 1, '');


SET @query = N'
SELECT cdempresa    = rhdbasic.cdempresa
     , cdfunc       = rhdbasic.cdfunc
     , nome         = rhdbasic.nome
     , perApur      = efds_s5001.perApur
     , Id           = efds_s5001_infocpcalc.Id
     , EFDS_S5001Id = efds_s5001_infocpcalc.EFDS_S5001Id
     , tpCR         = efds_s5001_infocpcalc.tpCR
     , vrCpSeg      = efds_s5001_infocpcalc.vrCpSeg
     , vrDescSeg    = efds_s5001_infocpcalc.vrDescSeg
     , Diferenca    = efds_s5001_infocpcalc.vrcpseg - efds_s5001_infocpcalc.vrdescseg
	 , ''|''		= ''|''
     , ' + @cols + '
FROM efds_s5001_infocpcalc
         INNER JOIN efds_s5001
                    ON (efds_s5001.id = efds_s5001_infocpcalc.efds_s5001Id)
         INNER JOIN rhdbasic
                    ON (rhdbasic.cpf = efds_s5001.cpfTrab)


         INNER JOIN EFDS_S5001_ideEstabLot
                    ON (efds_S5001.Id = EFDS_S5001_ideEstabLot.EFDS_S5001Id)

         INNER JOIN EFDS_S5001_infoCategIncid
                    ON (EFDS_S5001_infoCategIncid.EFDS_S5001_ideEstabLotId = EFDS_S5001_ideEstabLot.Id)

         OUTER APPLY (SELECT *
                      FROM (SELECT efds_s5001_infobasecs.tpvalor, EFDS_S5001_infoBaseCS.valor
                            FROM EFDS_S5001_infoBaseCS
                            WHERE EFDS_S5001_infoBaseCS.EFDS_S5001_infoCategIncidId = EFDS_S5001_infoCategIncid.Id) tbaux
                               PIVOT (
                               MAX(valor)
                               FOR tpvalor IN (' + @cols + ')
                               ) AS pvt) EFDS_S5001_infoBaseCS

WHERE efds_s5001.perApur = ''' + @perApur + '''
  AND efds_s5001.Status = ''' + @status + '''
  AND RhDBasic.CPF LIKE ''%' + @cpf + '%''
';


EXEC sp_executesql @query;






















DECLARE @cols		AS NVARCHAR(MAX);
DECLARE @query		AS NVARCHAR(MAX);
DECLARE @perApur	AS VARCHAR(7);
DECLARE @status		AS VARCHAR(1);
DECLARE @cpf		AS VARCHAR(11);
DECLARE @vrdescseg	AS CHAR(1);


SET @perApur = '2022-10'
SET @status = 'O'
SET @cpf = ''				-- caso não queira buscar o CPF deixar em branco
SET @vrdescseg = 'S'		-- S = Sim / N = Não


SET @cols = STUFF((SELECT DISTINCT ', ' + QUOTENAME(tpValor)
                   FROM EFDS_S5001_infoBaseCS
                   FOR XML PATH('')), 1, 1, '');


SET @query = N'
SELECT cdempresa    = rhdbasic.cdempresa
     , cdfunc       = rhdbasic.cdfunc
     , nome         = rhdbasic.nome
     , perApur      = efds_s5001.perApur
     , Id           = efds_s5001_infocpcalc.Id
     , EFDS_S5001Id = efds_s5001_infocpcalc.EFDS_S5001Id
     , tpCR         = efds_s5001_infocpcalc.tpCR
     , vrCpSeg      = efds_s5001_infocpcalc.vrCpSeg
     , vrDescSeg    = efds_s5001_infocpcalc.vrDescSeg
     , Diferenca    = efds_s5001_infocpcalc.vrcpseg - efds_s5001_infocpcalc.vrdescseg
	 , ''|''		= ''|''
     , ' + @cols + '
FROM efds_s5001_infocpcalc
         INNER JOIN efds_s5001
                    ON (efds_s5001.id = efds_s5001_infocpcalc.efds_s5001Id)
         INNER JOIN rhdbasic
                    ON (rhdbasic.cpf = efds_s5001.cpfTrab)


         INNER JOIN EFDS_S5001_ideEstabLot
                    ON (efds_S5001.Id = EFDS_S5001_ideEstabLot.EFDS_S5001Id)

         INNER JOIN EFDS_S5001_infoCategIncid
                    ON (EFDS_S5001_infoCategIncid.EFDS_S5001_ideEstabLotId = EFDS_S5001_ideEstabLot.Id)

         OUTER APPLY (SELECT *
                      FROM (SELECT efds_s5001_infobasecs.tpvalor, EFDS_S5001_infoBaseCS.valor
                            FROM EFDS_S5001_infoBaseCS
                            WHERE EFDS_S5001_infoBaseCS.EFDS_S5001_infoCategIncidId = EFDS_S5001_infoCategIncid.Id) tbaux
                               PIVOT (
                               MAX(valor)
                               FOR tpvalor IN (' + @cols + ')
                               ) AS pvt) EFDS_S5001_infoBaseCS

WHERE efds_s5001.perApur = ''' + @perApur + '''
  AND efds_s5001.Status = ''' + @status + '''
  AND RhDBasic.CPF LIKE ''%' + @cpf + '%''

  ' + IIF(@vrdescseg = 'S', 'AND efds_s5001_infocpcalc.vrcpseg - efds_s5001_infocpcalc.vrdescseg <> 0', '') + '

';


--PRINT @query
EXEC sp_executesql @query;