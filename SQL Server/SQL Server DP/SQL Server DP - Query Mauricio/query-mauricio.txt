DECLARE @cols AS NVARCHAR(MAX);
DECLARE @query AS NVARCHAR(MAX);
DECLARE @perApur AS VARCHAR(MAX);
DECLARE @status AS VARCHAR(MAX);
DECLARE @cpf AS VARCHAR(MAX);
DECLARE @cols_with_alias AS NVARCHAR(MAX);
DECLARE @cdEmpresa NCHAR(10)

SET @perApur = '2022-10'
SET @status = 'O'
SET @cpf = '' -- caso não queira buscar o CPF deixar em branco
SET @cdEmpresa = ''

DROP TABLE IF EXISTS #Apelidos
CREATE TABLE #Apelidos
(
    [tpValor] NCHAR(4),
    [Descricao] VARCHAR(MAX)
)

INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('11' , '11 - Base de cálculo da Contribuição Previdenciária normal;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('12' , '12 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('13' , '13 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('14' , '14 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('15' , '15 - Base de cálculo da contribuição previdenciária exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('21' , '21 - Valor total descontado do trabalhador para recolhimento à Previdência Social;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('22' , '22 - Valor descontado do trabalhador para recolhimento ao Sest;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('23' , '23 - Valor descontado do trabalhador para recolhimento ao Senat;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('31' , '31 - Valor pago ao trabalhador a título de salário-família;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('32' , '32 - Valor pago ao trabalhador a título de salário-maternidade;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('41' , '41 - Base de cálculo da Contribuição Previdenciária normal – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('42' , '42 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição – Categorias 107 e 108')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('43' , '43 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('44' , '44 - Base de cálculo da Contribuição Previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('45' , '45 - Base de cálculo da contribuição previdenciária adicional normal - exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('46' , '46 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('47' , '47 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('48' , '48 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição - exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('49' , '49 - Base de cálculo da contribuição previdenciária exclusiva do empregado – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('81' , '81 - Incidência suspensa em decorrência de decisão judicial - Base de cálculo (BC) da Contribuição Previdenciária (CP) Normal – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('82' , '82 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('83' , '83 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('84' , '84 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('85' , '85 - Incidência suspensa em decorrência de decisão judicial - BC CP normal - Exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('86' , '86 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho - Exclusiva do empregador –Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('87' , '87 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho - Exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('88' , '88 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho - Exclusiva do empregador – Categorias 107 e 108;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('91' , '91 - Incidência suspensa em decorrência de decisão judicial - Base de cálculo (BC) da Contribuição Previdenciária (CP) Normal;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('92' , '92 - Incid. suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('93' , '93 - Incid. suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('94' , '94 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('16' , '16 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 15 anos de contribuição - exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('17' , '17 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 20 anos de contribuição - exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('18' , '18 - Base de cálculo da contribuição previdenciária adicional para o financiamento dos benefícios de aposentadoria especial após 25 anos de contribuição - exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('19' , '19 - Base de cálculo da contribuição previdenciária exclusiva do empregado;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('95' , '95 - Incidência suspensa em decorrência de decisão judicial - BC CP normal - Exclusiva do empregador.')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('96' , '96 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 15 anos de trabalho - Exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('97' , '97 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 20 anos de trabalho - Exclusiva do empregador;')
INSERT INTO #apelidos ([tpValor], [Descricao]) VALUES ('98' , '98 - Incidência suspensa em decorrência de decisão judicial - BC CP Aposentadoria Especial aos 25 anos de trabalho - Exclusiva do empregador;')



SET @cols = STUFF((SELECT DISTINCT ', ' + QUOTENAME(tpValor)
                   FROM EFDS_S5001_infoBaseCS
                   FOR XML PATH('')), 1, 1, '');

SELECT @cols_with_alias = STUFF((SELECT distinct ', ' + QUOTENAME(LTRIM(RTRIM(m.[tpValor]))) + ' AS ' + QUOTENAME(m.[Descricao])
                      FROM EFDS_S5001_infoBaseCS s
                      JOIN #Apelidos m ON LTRIM(RTRIM(s.[tpValor])) COLLATE Latin1_General_CI_AS = LTRIM(RTRIM(m.[tpValor])) COLLATE Latin1_General_CI_AS
                      FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')

SET @query = N'
SELECT cdempresa    = rhdbasic.cdempresa
     , cdfunc       = rhdbasic.cdfunc
     , nome         = rhdbasic.nome
     , perApur      = efds_s5001.perApur
     , Id           = efds_s5001_infocpcalc.Id
     , EFDS_S5001Id = efds_s5001_infocpcalc.EFDS_S5001Id
     , tpCR         = efds_s5001_infocpcalc.tpCR
     , vrCpSeg      = efds_s5001_infocpcalc.vrCpSeg
     , vrDescSeg    = efds_s5001_infocpcalc.vrDescSeg
     , Diferenca    = efds_s5001_infocpcalc.vrcpseg - efds_s5001_infocpcalc.vrdescseg
	 , ''|''		= ''|''
     , ' + @cols_with_alias + '
FROM efds_s5001_infocpcalc
         INNER JOIN efds_s5001
                    ON (efds_s5001.id = efds_s5001_infocpcalc.efds_s5001Id)
         INNER JOIN rhdbasic
                    ON (rhdbasic.cpf = efds_s5001.cpfTrab)


         INNER JOIN EFDS_S5001_ideEstabLot
                    ON (efds_S5001.Id = EFDS_S5001_ideEstabLot.EFDS_S5001Id)

         INNER JOIN EFDS_S5001_infoCategIncid
                    ON (EFDS_S5001_infoCategIncid.EFDS_S5001_ideEstabLotId = EFDS_S5001_ideEstabLot.Id)

         OUTER APPLY (SELECT *
                      FROM (SELECT efds_s5001_infobasecs.tpvalor, EFDS_S5001_infoBaseCS.valor
                            FROM EFDS_S5001_infoBaseCS
                            WHERE EFDS_S5001_infoBaseCS.EFDS_S5001_infoCategIncidId = EFDS_S5001_infoCategIncid.Id) tbaux
                               PIVOT (
                               MAX(valor)
                               FOR tpvalor IN (' + @cols + ')
                               ) AS pvt) EFDS_S5001_infoBaseCS

WHERE efds_s5001.perApur = ''' + @perApur + '''
  AND efds_s5001.Status = ''' + @status + '''
  AND RhDBasic.CPF LIKE ''%' + @cpf + '%''
  AND RhDBasic.CdEmpresa = ''' + @cdEmpresa + '''
  AND efds_s5001_infocpcalc.vrcpseg-efds_s5001_infocpcalc.vrdescseg <> 0

ORDER BY RhDBasic.Nome ASC
';


EXEC sp_executesql @query;